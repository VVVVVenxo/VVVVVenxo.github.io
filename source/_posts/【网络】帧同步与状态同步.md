---
title: 【网络】帧同步与状态同步
toc: true
categories:
  - 技术笔记
  - 网络
cover: /img/covers/code_dark.jpg
date: 2025-06-05
tags:
  - 网络同步
  - 帧同步
  - 状态同步
description: 详解游戏网络同步的两种主流方案：帧同步与状态同步的核心区别、优缺点对比，以及适用的游戏类型。
---

## 核心区别

帧同步与状态同步最大的区别在于**战斗逻辑的执行位置**：

| 同步方式 | 战斗逻辑位置 | 网络协议 |
|----------|--------------|----------|
| **帧同步** | 客户端 | 一般基于 UDP |
| **状态同步** | 服务端 | 一般基于 TCP |

---

## 帧同步（Lockstep）

### 原理

- 服务端**只转发操作**，不做任何逻辑处理
- 所有客户端执行相同的输入，得到相同的结果
- 要求逻辑**严格确定性**（Deterministic）

### 流程

```
┌─────────┐     操作输入     ┌─────────┐     广播操作     ┌─────────┐
│ Client1 │ ───────────────► │ Server  │ ───────────────► │ Client2 │
└─────────┘                  └─────────┘                  └─────────┘
     │                            │                            │
     │   执行逻辑                 │ (只转发)                   │ 执行逻辑
     ▼                            │                            ▼
  游戏状态                        │                         游戏状态
```

### 优点

- 开发难度低（客户端独立开发）
- 流量小（只传输操作）
- 天然支持回放

### 缺点

- 客户端作弊难防
- 浮点误差可能导致不同步
- 断线重连复杂

### 代表游戏

- 王者荣耀
- 魔兽争霸 3
- 格斗游戏
- FPS 游戏

---

## 状态同步

### 原理

- 服务端执行战斗逻辑，计算游戏状态
- 客户端是服务端数据的**表现层**
- 服务端定期同步状态给客户端

### 流程

```
┌─────────┐     操作输入     ┌─────────┐     状态数据     ┌─────────┐
│ Client1 │ ───────────────► │ Server  │ ───────────────► │ Client2 │
└─────────┘                  └─────────┘                  └─────────┘
     │                            │                            │
     │   表现层                   │ 执行逻辑                   │ 表现层
     ▼                            ▼                            ▼
  渲染游戏                    游戏状态                      渲染游戏
```

### 优点

- 玩家作弊困难（服务端权威）
- 断线重连简单（直接同步状态）
- 允许小误差，定时纠正

### 缺点

- 流量更大（需要发送状态数据）
- 开发难度高（前后端配合）
- 需要处理预测和回滚

### 代表游戏

- MMO 游戏（魔兽世界）
- 需要强反外挂的游戏

---

## 详细对比

| 属性 | 帧同步 | 状态同步 |
|------|--------|----------|
| **确定性** | 严格确定 | 允许小误差，定时纠正 |
| **响应速度** | 传统帧锁定需等待；乐观帧锁定可立即响应但需回滚 | 可做预测立即响应；不做预测则响应 = RTT |
| **带宽流量** | 低，只传操作；随人数增加 | 高，需传状态；可压缩优化 |
| **延迟适应** | 低延迟要求；高延迟下体验下降 | 适应性高；高延迟可能位置突变 |
| **开发难度** | 初期简单；后期调 bug 困难（浮点误差、随机数、执行顺序） | 框架复杂；但问题定位容易 |
| **玩家数量** | 适合少量玩家（ACT、MOBA） | 可多可少 |
| **跨平台** | 不适合（浮点误差）；可用定点数 | 适合（有权威服务器） |
| **反外挂** | 不利反外挂；无法防透视 | 效果较好；仍无法防透视 |
| **中途加入/断线重连** | 复杂，需播放帧数据追进度 | 简单，直接同步状态 |
| **客户端性能** | 需跑完整逻辑和渲染 | 可灵活裁剪逻辑 |
| **离线回放** | 天然支持，回放文件小 | 需记录状态，回放文件大 |
| **实时回放** | 复杂，需序列化全场状态 | 相对简单，记录快照 |

---

## 选型建议

| 游戏类型 | 推荐方案 | 原因 |
|----------|----------|------|
| MOBA | 帧同步 | 玩家少、实时性要求高 |
| FPS | 帧同步 + 服务端校验 | 高实时性、需要反外挂 |
| 格斗游戏 | 帧同步 + GGPO 回滚 | 极低延迟要求 |
| MMO | 状态同步 | 大量玩家、需要强反外挂 |
| 休闲游戏 | 状态同步 | 开发简单、作弊风险低 |
| RTS | 帧同步 | 大量单位、流量考虑 |

---

## 混合方案

实际项目中常采用混合方案：

- **帧同步 + 服务端校验**：服务端也跑一份逻辑，用于反外挂
- **状态同步 + 客户端预测**：客户端预测执行，服务端确认后纠正
- **关键数据状态同步 + 表现帧同步**：关键逻辑服务端算，表现细节客户端算

---

## 确定性问题（帧同步）

帧同步要求所有客户端执行结果完全一致，需要注意：

| 问题 | 解决方案 |
|------|----------|
| 浮点误差 | 使用定点数（Fixed Point） |
| 随机数 | 使用确定性随机（种子同步） |
| 执行顺序 | 确保逻辑执行顺序一致 |
| 物理引擎 | 使用确定性物理库 |
